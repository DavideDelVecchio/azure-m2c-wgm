#!/bin/bash

# Bash shell script to execute a complete database migration,
# from mongoexport to CosmosDB loading, for a given source database.
#
# This script will execute several other generated scripts.
# Set the several M2C_OMNISCRIPT_* variables, as necessary, in env.sh.
#
# Database Name: {{ dbname }}
# Generated on:  {{ gen_timestamp }}
# Template:      migrate_db_omniscript.txt

# define verification filenames:
verify_storage_containers_file="tmp/omniscript_{{ dbname }}_storage_containers.json"
verify_wrangled_blobs_file="tmp/omniscript_{{ dbname }}_wrangled_blobs.json"
verify_target_cosmos_db_file="tmp/omniscript_{{ dbname }}_target_cosmos_db.json"
report_target_cosmos_db_file="tmp/omniscript_{{ dbname }}_target_cosmos_db_report.json"


source ./env.sh

mkdir -p tmp
rm $verify_storage_containers_file
rm $verify_wrangled_blobs_file
rm $verify_target_cosmos_db_file
rm $report_target_cosmos_db_file

# -----------------------------------------------------------------------------

if [[ $M2C_OMNISCRIPT_DO_MONGOEXPORTS == "yes" ]];
then
    ./{{ dbname }}_mongoexports.sh
fi

# -----------------------------------------------------------------------------

# Verify that the necessary Azure Storage Blob containers are present

python validate.py storage_containers {{ dbname }} $verify_storage_containers_file 

if [ -f "$verify_storage_containers_file" ];
then
    echo 'Azure Storage Blob containers are present, proceeding...'
else
    echo 'TERMINATING - Azure Storage container(s) are absent'
    exit 1
fi

# -----------------------------------------------------------------------------

if [[ $M2C_OMNISCRIPT_DO_MONGOEXPORT_UPLOADS == "yes" ]];
then
    if [[ $M2C_OMNISCRIPT_MONGOEXPORT_UPLOAD_METHOD == "azcli" ]];
    then
        ./{{ dbname }}_az_cli_mongoexport_uploads.sh
    else
        ./{{ dbname }}_python_mongoexport_uploads.sh
    fi
fi

# -----------------------------------------------------------------------------

if [[ $M2C_OMNISCRIPT_DO_WRANGLE == "yes" ]];
then
    ./wrangle_{{ dbname }}_all.sh
fi

# -----------------------------------------------------------------------------

if [[ $M2C_OMNISCRIPT_DO_COSMOS_LOAD == "yes" ]];
then
    python validate.py wrangled_blobs {{ dbname }} $verify_wrangled_blobs_file 
    python validate.py target_cosmos_db {{ dbname }} $verify_target_cosmos_db_file 

    if [ -f "$verify_wrangled_blobs_file" ];
    then
        echo 'Wranged Azure Storage Blobs are present, proceeding...'
    else
        echo 'TERMINATING - Wrangled blob(s) are absent'
        exit 2
    fi

    if [ -f "$verify_target_cosmos_db_file" ];
    then
        echo 'CosmosDB database and containers are present, proceeding...'
        ./load_cosmos_for_source_db_{{ dbname }}_all.sh
    else
        echo 'TERMINATING - Wrangled blob(s) are absent'
        exit 3
    fi

    # get CosmosDB document counts by collection
    python validate.py target_cosmos_docs {{ dbname }} $report_target_cosmos_db_file
fi

echo 'done'

