#!/bin/bash

# Bash shell script to wrangle/transform a raw mongoexport file
#
# Database Name: {{ dbname }}
# Generated on:  {{ gen_timestamp }}
# Template:      wrangle_one.txt

source ./env.sh

mkdir -p tmp/{{ dbname }}/out
mkdir -p out/{{ dbname }}

# This script does the following:
# 1) Downloads blob {{ blob_name }} from container {{ dbname }}-raw
#    to local file {{ local_file_path }}
# 2) Wrangle/transform the downloaded blob, producing local file 
#    {{ wrangled_outfile_path }}
# 3) Uploads the wrangled file to storage container {{ dbname }}-adf
# 4) Delete the downloaded and wrangled file, as the host VM may have limited storage
#
# Note: this script is executed by script {{ dbname }}_wrangle_all.sh

python wrangle.py transform_blob \
    --db {{ dbname }} \
    --in-container {{ dbname }}-raw \
    --blobname {{ blob_name }} \
    --filename {{ local_file_path }} \
    --outfile  {{ wrangled_outfile_path }} \
    --out-container {{ dbname }}-adf $1 $2 $3 

echo ''
echo 'first line of input file:'
head -1 {{ local_file_path }}

echo ''
echo 'first line of output file:'
head -1 {{ wrangled_outfile_path }}

# TODO - uncomment the next 3 lines after initial development
# echo 'deleting downloaded and wrangled files'
# rm {{ local_file_path }}
# rm {{ wrangled_outfile_path }}

echo 'done' 

